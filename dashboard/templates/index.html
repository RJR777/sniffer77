<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor - Dashboard</title>
    <meta name="description" content="Real-time network monitoring dashboard for LAN and WiFi devices">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <div class="bg-pattern"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üåê</div>
                <span class="logo-text">Network Monitor</span>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                <div class="status-indicator">
                    <span class="status-dot" id="connectionStatus"></span>
                    <span id="statusText">Connecting...</span>
                </div>
                <button class="shutdown-btn" onclick="confirmShutdown()" title="Shutdown System"
                    style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.2s;">
                    <span style="font-size: 1.1em;">‚èª</span> Shutdown
                </button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Stats Overview -->
        <section class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon devices">üì±</div>
                <div class="stat-label">Active Devices</div>
                <div class="stat-value" id="activeDevices">--</div>
                <div class="stat-change" id="totalDevices">/ -- total</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon upload">‚Üë</div>
                <div class="stat-label">Upload (1h)</div>
                <div class="stat-value" id="bytesSent">--</div>
                <div class="stat-change">Last hour</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon download">‚Üì</div>
                <div class="stat-label">Download (1h)</div>
                <div class="stat-value" id="bytesReceived">--</div>
                <div class="stat-change">Last hour</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bandwidth">üìä</div>
                <div class="stat-label">Total Bandwidth</div>
                <div class="stat-value" id="totalBandwidth">--</div>
                <div class="stat-change" id="lastUpdate">--</div>
            </div>
        </section>

        <!-- Devices Section -->
        <section class="section-header">
            <h2 class="section-title">
                <span class="section-title-icon">üñ•Ô∏è</span>
                Network Devices
            </h2>
        </section>

        <div class="devices-grid" id="devicesGrid">
            <div class="loading">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>

        <!-- Top Talkers Section -->
        <section class="activity-section">
            <div class="activity-header">
                <h2 class="section-title">
                    <span class="section-title-icon">üìà</span>
                    Top Bandwidth Consumers
                </h2>
            </div>
            <table class="activity-table" id="topTalkersTable">
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>MAC Address</th>
                        <th>IP Address</th>
                        <th>Manufacturer</th>
                        <th>Upload</th>
                        <th>Download</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="topTalkersBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Live Activity Section -->
        <section class="activity-section">
            <div class="activity-header">
                <h2 class="section-title">
                    <span class="section-title-icon">‚ö°</span>
                    Live Traffic
                </h2>
            </div>
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>MAC Address</th>
                        <th>Manufacturer</th>
                        <th>Packets ‚Üë</th>
                        <th>Packets ‚Üì</th>
                        <th>Bytes ‚Üë</th>
                        <th>Bytes ‚Üì</th>
                        <th>Protocols</th>
                    </tr>
                </thead>
                <tbody id="liveStatsBody">
                    <tr>
                        <td colspan="8" class="empty-state">Waiting for traffic data...</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <script>
        // Native WebSocket connection
        let socket = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
                reconnectAttempts = 0;
                socket.send(JSON.stringify({ type: 'request_update' }));
            };

            socket.onclose = () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    reconnectAttempts++;
                    console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                    setTimeout(connectWebSocket, delay);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'connected' || data.type === 'stats_update') {
                        if (data.summary) updateSummary(data.summary);
                        if (data.devices) updateDevices(data.devices);
                        if (data.top_talkers) updateTopTalkers(data.top_talkers);
                        if (data.live_stats) updateLiveStats(data.live_stats);
                    }
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };
        }

        // Track monitoring state locally
        const monitoringState = {};

        function setButtonActive(btn) {
            btn.textContent = 'Stop Monitoring';
            btn.classList.add('active');
        }

        function setButtonInactive(btn) {
            btn.textContent = 'Start Monitoring';
            btn.classList.remove('active');
        }

        async function toggleMonitoring(mac, btn) {
            const isMonitoring = monitoringState[mac];
            const action = isMonitoring ? 'stop' : 'start';

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const res = await fetch(`/api/device/${mac}/monitor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                const data = await res.json();

                if (data.success) {
                    monitoringState[mac] = (action === 'start');
                    if (action === 'start') {
                        setButtonActive(btn);
                    } else {
                        setButtonInactive(btn);
                    }
                } else {
                    alert('Error: ' + data.error);
                    if (isMonitoring) setButtonActive(btn);
                    else setButtonInactive(btn);
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            } finally {
                btn.disabled = false;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0 || bytes === undefined || bytes === null) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionStatus');
            const text = document.getElementById('statusText');
            isConnected = connected;

            if (connected) {
                dot.style.background = '#10b981';
                text.textContent = 'Live';
            } else {
                dot.style.background = '#ef4444';
                text.textContent = 'Disconnected';
            }
        }

        function updateSummary(summary) {
            document.getElementById('activeDevices').textContent = summary.active_devices || 0;
            document.getElementById('totalDevices').textContent = `/ ${summary.total_devices || 0} total`;
            document.getElementById('bytesSent').textContent = formatBytes(summary.bytes_sent_hour);
            document.getElementById('bytesReceived').textContent = formatBytes(summary.bytes_received_hour);

            const total = (summary.bytes_sent_hour || 0) + (summary.bytes_received_hour || 0);
            document.getElementById('totalBandwidth').textContent = formatBytes(total);
            document.getElementById('lastUpdate').textContent = `Updated: ${formatTime(summary.timestamp)}`;
        }

        function updateDevices(devices) {
            const grid = document.getElementById('devicesGrid');

            if (!devices || devices.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì°</div><p>No devices discovered yet. Make sure the sniffer is running.</p></div>';
                return;
            }

            grid.innerHTML = devices.map(device => {
                const osIcon = device.os_type && device.os_type.toLowerCase().includes('windows') ? 'ü™ü' :
                    device.os_type && device.os_type.toLowerCase().includes('apple') ? 'üçé' :
                        device.os_type && device.os_type.toLowerCase().includes('android') ? 'ü§ñ' :
                            device.os_type && device.os_type.toLowerCase().includes('linux') ? 'üêß' : 'üíª';

                return `
                <div class="device-card ${device.is_active ? 'active' : ''}">
                    <div class="device-header">
                        <div class="device-info">
                            <div class="device-name" style="font-size: 1.1rem; font-weight: 700; margin-bottom: 4px;">
                                ${osIcon} ${device.custom_name || device.hostname || 'Unknown Device'}
                            </div>
                            <div class="device-manufacturer" style="opacity: 0.8; font-size: 0.9rem;">${device.manufacturer || 'Unknown Manufacturer'}</div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                ${device.device_type ? `<span class="badge badge-info" style="font-size: 0.65rem;">${device.device_type}</span>` : ''}
                                ${device.os_type ? `<span class="badge badge-success" style="font-size: 0.65rem;">${device.os_type}</span>` : ''}
                            </div>
                        </div>
                        <div class="device-status ${device.is_active ? '' : 'inactive'}" title="${device.is_active ? 'Online' : 'Offline'}"></div>
                    </div>
                    <div class="device-details" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <div class="device-detail">
                            <span class="device-detail-label">Network Info</span>
                            <span class="device-detail-value">${device.ip || 'N/A'} ‚Ä¢ ${device.mac}</span>
                        </div>
                        ${device.dhcp_lease_display ? `
                        <div class="device-detail">
                            <span class="device-detail-label">DHCP Lease</span>
                            <span class="device-detail-value">${device.dhcp_lease_display}</span>
                        </div>` : ''}
                        ${device.discovery_methods && device.discovery_methods.length > 0 ? `
                        <div class="device-detail">
                            <span class="device-detail-label">Discovered via</span>
                            <span class="device-detail-value" style="text-transform: uppercase; font-size: 0.7em; color: var(--accent-secondary); font-weight: 600;">${device.discovery_methods.join(', ')}</span>
                        </div>` : ''}
                    </div>
                    <div class="device-traffic" style="display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; margin-top: auto;">
                        ${monitoringState[device.mac] ? `
                            <div class="traffic-item up">üöÄ ${device.sent_formatted || '0 B'}</div>
                            <div class="traffic-item down">‚òÑÔ∏è ${device.received_formatted || '0 B'}</div>
                        ` : `
                            <div style="width: 100%; text-align: center; opacity: 0.7; font-size: 0.8em;">
                                ${device.services && device.services.length > 0 ?
                        `<span title="Open ports">üîå ${device.services.slice(0, 3).join(', ')}</span>` :
                        `<span>üì° Discovered via ${(device.discovery_methods || ['arp']).join(', ')}</span>`}
                            </div>
                        `}
                    </div>
                    <div class="device-actions">
                        <button class="monitor-btn ${monitoringState[device.mac] ? 'active' : ''}" 
                                onclick="toggleMonitoring('${device.mac}', this)" 
                                data-mac="${device.mac}">
                            ${monitoringState[device.mac] ? 'Stop Monitoring' : 'Start Monitoring'}
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateTopTalkers(talkers) {
            const tbody = document.getElementById('topTalkersBody');

            if (!talkers || talkers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No traffic data yet</td></tr>';
                return;
            }

            tbody.innerHTML = talkers.map(t => `
                <tr>
                    <td><strong>${t.custom_name || t.hostname || 'Unknown'}</strong></td>
                    <td><span class="mac-address">${t.mac}</span></td>
                    <td><span class="ip-address">${t.ip || 'N/A'}</span></td>
                    <td>${t.manufacturer || 'Unknown'}</td>
                    <td class="traffic-item up">‚Üë ${formatBytes(t.bytes_sent)}</td>
                    <td class="traffic-item down">‚Üì ${formatBytes(t.bytes_received)}</td>
                    <td><span class="badge badge-info">${formatBytes(t.total_bytes)}</span></td>
                </tr>
            `).join('');
        }

        function updateLiveStats(stats) {
            const tbody = document.getElementById('liveStatsBody');

            if (!stats || Object.keys(stats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Waiting for traffic data...</td></tr>';
                return;
            }

            const sorted = Object.values(stats).sort((a, b) =>
                (b.bytes_sent + b.bytes_received) - (a.bytes_sent + a.bytes_received)
            ).slice(0, 20);

            tbody.innerHTML = sorted.map(s => {
                const protocols = Object.keys(s.protocols || {}).slice(0, 3);
                return `
                    <tr>
                        <td><strong>${s.hostname || 'Unknown'}</strong></td>
                        <td><span class="mac-address">${s.mac}</span></td>
                        <td>${s.manufacturer || 'Unknown'}</td>
                        <td>${s.packets_sent.toLocaleString()}</td>
                        <td>${s.packets_received.toLocaleString()}</td>
                        <td class="traffic-item up">‚Üë ${formatBytes(s.bytes_sent)}</td>
                        <td class="traffic-item down">‚Üì ${formatBytes(s.bytes_received)}</td>
                        <td>
                            <div class="protocol-pills">
                                ${protocols.map(p => `<span class="protocol-pill">${p}</span>`).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function confirmShutdown() {
            if (confirm("Are you sure you want to SHUT DOWN the network monitor and dashboard? This will stop all sniffing and discovery.")) {
                fetch('/api/shutdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("System shutting down. This page will no longer update.");
                            document.body.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #0f172a; color: white; font-family: sans-serif;">
                            <h1 style="color: #ef4444;">System Offline</h1>
                            <p>The network monitor has been shut down gracefully.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Reconnect</button>
                        </div>
                    `;
                        } else {
                            alert("Shutdown failed: " + data.error);
                        }
                    })
                    .catch(err => {
                        console.error("Shutdown error:", err);
                        alert("System is shutting down...");
                    });
            }
        }

        // Start WebSocket connection
        connectWebSocket();
    </script>
</body>

</html>